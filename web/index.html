<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Powered Multi-Disease Prediction System</title>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-light: #f3f4f6;
            --card-light: #ffffff;
            --text-main: #0f172a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-main);
        }

        .navbar-brand span {
            font-weight: 700;
        }

        .page-wrapper {
            min-height: 100vh;
            padding: 1.5rem 0;
        }

        .app-title {
            font-weight: 700;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .card-shell {
            border-radius: 1.25rem;
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.10);
        }

        .form-card {
            border-radius: 1.25rem;
            background: var(--card-light);
            height: 100%;
        }

        .result-card {
            border-radius: 1.25rem;
            background: var(--card-light);
            height: 100%;
        }

        .symptom-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
            margin: 0.22rem;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s;
        }
        .symptom-chip input {
            display: none;
        }
        .symptom-chip.active {
            background: #eff6ff;
            border-color: #2563eb;
            transform: translateY(-1px);
        }

        .symptom-list {
            max-height: 260px;
            overflow-y: auto;
            padding-right: 0.25rem;
        }

        .risk-badge {
            border-radius: 999px;
            padding: 0.15rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .risk-low {
            background: #dcfce7;
            color: #166534;
        }
        .risk-medium {
            background: #fef9c3;
            color: #854d0e;
        }
        .risk-high {
            background: #fee2e2;
            color: #991b1b;
        }

        /* --- Dark mode styles --- */
        body.dark-mode {
            background: #020617;
            color: #e5e7eb;
        }

        body.dark-mode .navbar {
            background-color: #020617 !important;
            border-color: #1f2937 !important;
        }

        body.dark-mode .navbar .navbar-brand span {
            color: #e5e7eb;
        }

        body.dark-mode .form-card,
        body.dark-mode .result-card {
            background: #020617;
            color: #e5e7eb;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid #1f2937;
        }

        body.dark-mode .app-title,
        body.dark-mode .subtitle {
            color: #e5e7eb;
        }

        body.dark-mode .form-label,
        body.dark-mode .h2,
        body.dark-mode .h4,
        body.dark-mode .h5,
        body.dark-mode h6,
        body.dark-mode p,
        body.dark-mode li {
            color: #e5e7eb;
        }

        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #020617;
            border-color: #374151;
            color: #e5e7eb;
        }

        body.dark-mode .form-control::placeholder {
            color: #6b7280;
        }

        body.dark-mode .symptom-chip {
            border-color: #374151;
            color: #e5e7eb;
        }

        body.dark-mode .symptom-chip.active {
            background: #1d4ed8;
            border-color: #60a5fa;
        }

        body.dark-mode .risk-low {
            background: rgba(22, 101, 52, 0.15);
        }

        body.dark-mode .risk-medium {
            background: rgba(133, 77, 14, 0.15);
        }

        body.dark-mode .risk-high {
            background: rgba(153, 27, 27, 0.15);
        }

        body.dark-mode .btn-primary {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        body.dark-mode .btn-outline-secondary {
            border-color: #6b7280;
            color: #e5e7eb;
        }

body.dark-mode .bg-light {
    background-color: #020617 !important;
}

body.dark-mode #result-card {
    background-color: #020617 !important;
    border-color: #374151 !important;
}

/* Make AI summary / answer boxes dark */
body.dark-mode #ai-summary,
body.dark-mode #ai-answer {
    background-color: #020617;
    border-radius: 0.75rem;
}
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <span class="me-2">ü©∫</span><span>MedAI Predict</span>
    </a>
          <div class="ms-auto d-flex align-items-center gap-2">
      <span id="user-info" style="font-size:0.85rem;" class="text-muted d-none">
        Hi, <span id="user-name"></span>
      </span>
      <button id="admin-btn" class="btn btn-outline-warning btn-sm d-none">
        Admin Panel
      </button>
      <button id="history-btn" class="btn btn-outline-primary btn-sm d-none">
        History
      </button>
      <button id="logout-btn" class="btn btn-outline-danger btn-sm d-none">
        Logout
      </button>
      <button id="theme-toggle" class="btn btn-outline-secondary btn-sm">
        üåô Dark Mode
      </button>
    </div>


  </div>
</nav>

<div class="page-wrapper">
  <div class="container">
    <div class="mb-3">
      <h1 class="h4 app-title mb-1">AI Powered Multi-Disease Prediction System</h1>
      <p class="subtitle mb-0">
        Enter patient details, select symptoms, and let the AI model estimate the most likely conditions.
      </p>
    </div>

    <div class="row g-4">
      <!-- Left: Input -->
      <div class="col-lg-6">
        <div class="form-card p-4 card-shell">
          <h2 class="h5 mb-3">Patient & Symptom Details</h2>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Age</label>
              <input type="number" id="age" class="form-control" placeholder="e.g. 28">
            </div>
            <div class="col-md-4">
              <label class="form-label">Gender</label>
              <select id="gender" class="form-select">
                <option value="" selected disabled>Select...</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Duration (days)</label>
              <input type="number" id="duration" class="form-control" placeholder="e.g. 5">
            </div>
          </div>

          <div class="mb-2 d-flex justify-content-between align-items-center">
            <h2 class="h6 mb-0">Select Symptoms</h2>
            <small class="text-muted" style="font-size: 0.8rem;">
              Selected: <span id="selected-count">0</span>
            </small>
          </div>

          <div class="d-flex gap-2 mb-2">
            <input
              type="text"
              id="symptom-search"
              class="form-control"
              placeholder="Search symptoms..."
            />
            <button id="clear-btn" class="btn btn-outline-danger">
              Clear All
            </button>
          </div>

          <div id="symptom-container" class="symptom-list border rounded-3 p-2">
            <!-- Symptoms load here -->
          </div>

          <div class="d-flex justify-content-end mt-3">
            <button id="predict-btn" class="btn btn-primary">
              Run AI Prediction
            </button>
          </div>
        </div>
      </div>

      <!-- Right: Result -->
      <div class="col-lg-6">
        <div class="result-card p-4 card-shell">
          <h2 class="h5 mb-3">Prediction Result</h2>

          <div id="result-section" class="">
            <div id="result-card" class="border rounded-3 p-3 bg-light">
              <p class="mb-0 text-muted" style="font-size: 0.9rem;">
                No assessment yet. Fill details and click <strong>Run AI Prediction</strong> to see results here.
              </p>
            </div>
            <button id="download-report-btn" class="btn btn-outline-secondary btn-sm mt-3 d-none">
              Download Report (PDF)
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const symptomContainer = document.getElementById("symptom-container");
  const downloadBtn = document.getElementById("download-report-btn");
  const searchInput = document.getElementById("symptom-search");
  const clearBtn = document.getElementById("clear-btn");
  const selectedCountEl = document.getElementById("selected-count");
  const themeToggleBtn = document.getElementById("theme-toggle");
  const userInfoSpan = document.getElementById("user-info");
const userNameSpan = document.getElementById("user-name");
const historyBtn = document.getElementById("history-btn");
const logoutBtn = document.getElementById("logout-btn");
const adminBtn = document.getElementById("admin-btn");


  let lastPrediction = null;
  let lastSelectedSymptoms = [];

  // Load symptoms from backend when page loads
  async function loadSymptoms() {
    try {
      const response = await fetch("/symptoms");
      const data = await response.json();

      const symptoms = data.symptoms || [];

      if (symptoms.length === 0) {
        symptomContainer.innerHTML = `<p class="text-danger mb-0">No symptoms found from model.</p>`;
        return;
      }

      symptoms.forEach(sym => {
        const chip = document.createElement("label");
        chip.className = "symptom-chip";

        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = sym;

        input.addEventListener("change", () => {
          chip.classList.toggle("active", input.checked);
          updateSelectedCount();
        });

        const span = document.createElement("span");
        span.textContent = sym.replaceAll("_", " ");

        chip.appendChild(input);
        chip.appendChild(span);
        symptomContainer.appendChild(chip);
      });
    } catch (err) {
      console.error(err);
      symptomContainer.innerHTML = `<p class="text-danger mb-0">Failed to load symptoms from server.</p>`;
    }
  }

  loadSymptoms();
  // Fetch current user info (for navbar)
async function loadCurrentUser() {
  try {
    const resp = await fetch("/api/current-user");
    const data = await resp.json();

    if (data.logged_in) {
      userNameSpan.textContent = data.name || data.email || "User";
      userInfoSpan.classList.remove("d-none");
      logoutBtn.classList.remove("d-none");

      // Normal users get History button
      if (data.role === "patient" || !data.role) {
        historyBtn.classList.remove("d-none");
      }

      // Admin gets Admin Panel button
      if (data.role === "admin") {
        adminBtn.classList.remove("d-none");
      }
    } else {
      window.location.href = "/login";
    }
  } catch (err) {
    console.error("Failed to fetch current user:", err);
    window.location.href = "/login";
  }
}


// Call on page load
loadCurrentUser();


  function updateSelectedCount() {
    const selected = document.querySelectorAll(".symptom-chip input:checked");
    selectedCountEl.textContent = selected.length;
  }

  // Search filter
  searchInput.addEventListener("input", () => {
    const searchTerm = searchInput.value.toLowerCase();
    const chips = document.querySelectorAll(".symptom-chip");

    chips.forEach(chip => {
      const text = chip.innerText.toLowerCase();
      chip.style.display = text.includes(searchTerm) ? "inline-flex" : "none";
    });
  });

  // Clear all
  clearBtn.addEventListener("click", () => {
    const inputs = document.querySelectorAll(".symptom-chip input");

    inputs.forEach(input => {
      input.checked = false;
      input.parentElement.classList.remove("active");
    });

    updateSelectedCount();

    const resultCard = document.getElementById("result-card");
    resultCard.innerHTML = `
      <p class="mb-0 text-muted" style="font-size: 0.9rem;">
        No assessment yet. Fill details and click <strong>Run AI Prediction</strong> to see results here.
      </p>
    `;
    downloadBtn.classList.add("d-none");
    lastPrediction = null;
    lastSelectedSymptoms = [];
  });

  // Predict handler
  document.getElementById("predict-btn").addEventListener("click", async () => {
    const selected = Array.from(
      document.querySelectorAll(".symptom-chip input:checked")
    ).map(el => el.value);

    const resultCard = document.getElementById("result-card");

    if (selected.length === 0) {
      resultCard.innerHTML = `<p class="text-danger mb-0">Please select at least one symptom.</p>`;
      downloadBtn.classList.add("d-none");
      lastPrediction = null;
      lastSelectedSymptoms = [];
      return;
    }

    resultCard.innerHTML = `<p class="mb-0">Running prediction...</p>`;
    downloadBtn.classList.add("d-none");
    lastPrediction = null;
    lastSelectedSymptoms = [];

    try {
      const response = await fetch("/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symptoms: selected })
      });

      const data = await response.json();
      lastPrediction = data;
      lastSelectedSymptoms = selected;

      const mainConfidence = data.confidence
        ? (data.confidence * 100).toFixed(2)
        : "‚Äî";

      let riskClass = "risk-low";
      let riskLabel = "Low Risk";
      if (data.confidence !== null) {
        if (data.confidence >= 0.8) {
          riskClass = "risk-high";
          riskLabel = "High Risk";
        } else if (data.confidence >= 0.5) {
          riskClass = "risk-medium";
          riskLabel = "Moderate Risk";
        }
      }

      const topPreds = data.top_predictions || [];
      let topPredictionsHtml = "";

      if (topPreds.length > 0) {
        topPredictionsHtml = `
          <h6 class="mt-3 mb-2">Top 3 probable conditions</h6>
          <ul class="mb-2" style="font-size: 0.9rem;">
            ${topPreds
              .map(p => {
                const conf = p.confidence !== null
                  ? (p.confidence * 100).toFixed(2) + "%"
                  : "‚Äî";
                return `<li><strong>${p.disease}</strong> - ${conf}</li>`;
              })
              .join("")}
          </ul>
        `;
      }

      // Build base layout (NO static description/precautions now)
      resultCard.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="text-muted" style="font-size: 0.8rem;">Most likely condition</div>
            <div class="h5 mb-0">${data.disease}</div>
          </div>
          <div class="text-end">
            <div style="font-size: 0.8rem;">Confidence</div>
            <div class="h4 mb-0">${mainConfidence}%</div>
          </div>
        </div>
        <span class="risk-badge ${riskClass}">${riskLabel}</span>

        <hr>

        <p style="font-size: 0.9rem;">
          <strong>Model Output:</strong> Based on the symptoms you selected, the machine learning model finds
          <strong>${data.disease}</strong> to be the most probable condition.
        </p>

        ${topPredictionsHtml}

        <h6 class="mt-3 mb-1">AI summary & general precautions</h6>
        <p class="text-muted" style="font-size: 0.8rem;">
          This explanation is generated by the integrated Gemini API for education and awareness only.
        </p>
        <div id="ai-summary" style="font-size:0.9rem; border-radius:0.75rem; padding:0.75rem 0.9rem; background:#f9fafb; margin-bottom:0.5rem;">
          Fetching AI summary...
        </div>

        <hr class="mt-3">

        <h6 class="mt-2 mb-1">Ask Health AI a follow-up question</h6>
        <p style="font-size:0.8rem;" class="text-muted">
          You can ask for more clarification or lifestyle tips. This is not a medical diagnosis.
        </p>
        <div class="mb-2">
          <textarea id="ai-question" class="form-control" rows="2"
            placeholder="e.g. What lifestyle changes can help with this condition?"></textarea>
        </div>
        <button id="ask-ai-btn" class="btn btn-outline-primary btn-sm mb-2">
          Ask Health AI
        </button>
        <div id="ai-answer" style="font-size:0.9rem; border-radius:0.75rem; padding:0.5rem 0.75rem; background:#f9fafb;"></div>

        <p class="mt-3" style="font-size: 0.8rem; color: #6b7280;">
          <strong>Disclaimer:</strong> This tool is for educational and preliminary screening purposes only.
          It is <u>not</u> a medical diagnosis. Always consult a qualified healthcare professional for
          diagnosis and treatment.
        </p>
      `;

      downloadBtn.classList.remove("d-none");

      // --- Hook AI elements ---
            // --- Hook AI elements ---
      const aiSummaryDiv = document.getElementById("ai-summary");
      const askAiBtn = document.getElementById("ask-ai-btn");
      const aiQuestionInput = document.getElementById("ai-question");
      const aiAnswerDiv = document.getElementById("ai-answer");

      // 1) Auto-call Gemini once to generate summary + precautions
      (async () => {
        try {
          const resp = await fetch("/ask-ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question:
                "Explain this result in 1 short paragraph and list 4-6 general precautions as bullet points. " +
                "Respond in exactly this format:\n" +
                "ABOUT:\n" +
                "<one short paragraph>\n" +
                "PRECAUTIONS:\n" +
                "- point 1\n" +
                "- point 2\n" +
                "- point 3\n" +
                "- point 4\n",
              prediction: lastPrediction,
              symptoms: lastSelectedSymptoms
            })
          });

          const d = await resp.json();
          if (d.error) {
            aiSummaryDiv.textContent = d.error;
            return;
          }

          const raw = d.answer || "";
          let aboutText = raw;
          let precautions = [];

          // Split on PRECAUTIONS:
          const parts = raw.split(/PRECAUTIONS:/i);
          if (parts.length > 1) {
            // Part before PRECAUTIONS = ABOUT section
            aboutText = parts[0].replace(/ABOUT:/i, "").trim();

            // Part after PRECAUTIONS = bullet text
            const precautionsBlock = parts[1].trim();

            // Split by newlines and clean bullets (-, ‚Ä¢, numbers)
            precautions = precautionsBlock
              .split(/\r?\n/)
              .map(line => line.replace(/^[-‚Ä¢\d\.\s]+/, "").trim())
              .filter(line => line.length > 0);
          }

          // Build clean HTML: About + bullet list
          let html = `
            <h6 class="mb-1">About this condition</h6>
            <p style="font-size:0.9rem;">${aboutText}</p>
          `;

          if (precautions.length > 0) {
            html += `
              <h6 class="mt-2 mb-1">Suggested precautions</h6>
              <ul style="font-size:0.9rem;">
                ${precautions.map(p => `<li>${p}</li>`).join("")}
              </ul>
            `;
          }

          aiSummaryDiv.innerHTML = html;
        } catch (err) {
          console.error(err);
          aiSummaryDiv.textContent = "AI summary is not available right now.";
        }
      })();


      // 2) Handle follow-up questions via Ask Health AI
      askAiBtn.addEventListener("click", async () => {
        const questionText = aiQuestionInput.value.trim();
        if (!questionText) {
          aiAnswerDiv.textContent = "Please type a question to ask.";
          return;
        }

        aiAnswerDiv.textContent = "Contacting AI assistant...";

        try {
          const resp = await fetch("/ask-ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question: questionText,
              prediction: lastPrediction,
              symptoms: lastSelectedSymptoms
            })
          });

          const d = await resp.json();

          if (d.error) {
            aiAnswerDiv.textContent = d.error;
          } else {
            aiAnswerDiv.textContent = d.answer;
          }
        } catch (err) {
          console.error(err);
          aiAnswerDiv.textContent = "AI assistant is not available right now.";
        }
      });

    } catch (err) {
      console.error(err);
      resultCard.innerHTML = `<p class="text-danger mb-0">Error contacting prediction server.</p>`;
      downloadBtn.classList.add("d-none");
      lastPrediction = null;
      lastSelectedSymptoms = [];
    }
  });

  // History button ‚Üí go to history page
historyBtn.addEventListener("click", () => {
  window.location.href = "/history";
});

// Logout button ‚Üí call logout API and go to login
logoutBtn.addEventListener("click", async () => {
  try {
    await fetch("/api/logout", { method: "POST" });
  } catch (err) {
    console.error(err);
  }
  window.location.href = "/login";
});
adminBtn.addEventListener("click", () => {
  window.location.href = "/admin";
});


  // PDF download
  downloadBtn.addEventListener("click", async () => {
    if (!lastPrediction || lastSelectedSymptoms.length === 0) {
      alert("Please run a prediction before downloading the report.");
      return;
    }

    const age = document.getElementById("age").value || "";
    const gender = document.getElementById("gender").value || "";
    const duration = document.getElementById("duration").value || "";

    try {
      const response = await fetch("/generate-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          symptoms: lastSelectedSymptoms,
          age,
          gender,
          duration
        })
      });

      if (!response.ok) {
        alert("Failed to generate report.");
        return;
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ai_disease_report.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      alert("Error while downloading the report.");
    }
  });

  // Dark mode toggle
  themeToggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    themeToggleBtn.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
  });
</script>


</body>
</html>
